---
# This task file is used to detect whether an existing RKE2 install is already up and healthy.
# It must be safe to run *before* installation (i.e., when no certs/kubeconfig exist yet).

- name: Initialize node readiness facts
  ansible.builtin.set_fact:
    rke2_api_server_running: "{{ rke2_api_server_running | default(false) }}"
    rke2_metrics_running: "{{ rke2_metrics_running | default(false) }}"
    rke2_node_ready: "{{ rke2_node_ready | default(false) }}"

- name: Wait for k8s apiserver
  ansible.builtin.wait_for:
    host: localhost
    port: "6443"
    state: present
    timeout: "{{ check_node_ready_timeout }}"
  changed_when: false
  register: api_serve_status
  ignore_errors: "{{ check_node_ready_ignore_errors }}"

- name: Mark apiserver as running
  ansible.builtin.set_fact:
    rke2_api_server_running: true
  when:
    - api_serve_status is defined
    - api_serve_status.state is defined
    - api_serve_status.state == "present"

- name: Check for kubelet client certs (metrics auth)
  ansible.builtin.stat:
    path: /var/lib/rancher/rke2/server/tls/client-admin.crt
  register: rke2_client_admin_crt
  when: rke2_api_server_running | bool

- name: Get node_metrics
  ansible.builtin.uri:
    url: https://localhost:10250/metrics
    return_content: true
    ca_path: /var/lib/rancher/rke2/server/tls/server-ca.crt
    client_cert: /var/lib/rancher/rke2/server/tls/client-admin.crt
    client_key: /var/lib/rancher/rke2/server/tls/client-admin.key
  register: node_metrics
  retries: "{{ check_node_ready_retries }}"
  delay: "{{ check_node_ready_delay }}"
  ignore_errors: "{{ check_node_ready_ignore_errors }}"
  when:
    - rke2_api_server_running | bool
    - rke2_client_admin_crt is defined
    - rke2_client_admin_crt.stat is defined
    - rke2_client_admin_crt.stat.exists | bool

- name: Mark metrics as running
  ansible.builtin.set_fact:
    rke2_metrics_running: true
  when:
    - node_metrics is defined
    - node_metrics.status is defined
    - (node_metrics.status | string) == "200"

- name: Extract the kubelet_node_name from node metrics
  ansible.builtin.set_fact:
    kubelet_node_name: "{{ node_metrics.content | regex_search('kubelet_node_name{node=\"(.*)\"}', '\\1') }}"
  when:
    - rke2_metrics_running | bool
    - node_metrics is defined
    - node_metrics.content is defined

- name: Wait for node to show Ready status
  ansible.builtin.command: >-
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml
    --server https://127.0.0.1:6443 get no {{ kubelet_node_name[0] }}
    -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  register: status_result
  until: status_result.stdout.find("True") != -1
  retries: "{{ check_node_ready_retries }}"
  delay: "{{ check_node_ready_delay }}"
  changed_when: false
  ignore_errors: "{{ check_node_ready_ignore_errors }}"
  when:
    - rke2_api_server_running | bool
    - kubelet_node_name is defined
    - kubelet_node_name | length > 0

- name: Mark node as ready
  ansible.builtin.set_fact:
    rke2_node_ready: true
  when:
    - status_result is defined
    - status_result.rc is defined
    - (status_result.rc | string) == "0"
    - status_result.stdout is defined
    - status_result.stdout.find("True") != -1

- name: Node status
  ansible.builtin.debug:
    msg: |
      "rke2_node_ready: {{ rke2_node_ready }}"
      "rke2_metrics_running: {{ rke2_metrics_running }}"
      "rke2_api_server_running: {{ rke2_api_server_running }}"
